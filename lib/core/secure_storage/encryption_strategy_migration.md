# Миграция стратегии шифрования v3.0

## Изменения в стратегии

### Старая стратегия (v2.0):
- Весь файл шифровался целиком с использованием AES-256-GCM
- Файлы имели расширение `.encrypted`
- Для чтения любого ключа требовалось расшифровать весь файл

### Новая стратегия (v3.0):
- Файлы хранятся в формате JSON с читаемыми ключами
- Шифруются только значения, ключи остаются в открытом виде
- Файлы имеют расширение `.secure.json`
- Каждое значение шифруется индивидуально

## Преимущества новой стратегии

1. **Эффективность**: Возможность читать структуру данных без полного дешифрования
2. **Индексирование**: Ключи доступны для поиска и индексирования
3. **Частичные обновления**: Можно обновлять отдельные значения без пересохранения всего файла
4. **Отладка**: Структура данных видна в файле, что упрощает отладку
5. **Совместимость**: Поддержка старого формата для миграции

## Пример структуры файла

### Старый формат (.encrypted):
```
gAAAAABhJK7...зашифрованные_данные...xyz123==
```

### Новый формат (.secure.json):
```json
{
  "user_credentials": {
    "_encrypted": true,
    "_value": "gAAAAABhJK7...зашифрованное_значение...xyz123=="
  },
  "user_preferences": {
    "_encrypted": true,
    "_value": "gAAAAABhJK8...другое_зашифрованное_значение...abc456=="
  },
  "_metadata": {
    "version": "3.0",
    "createdAt": "2025-08-29T10:00:00.000Z",
    "updatedAt": "2025-08-29T10:00:00.000Z",
    "checksum": "sha256_hash_here"
  },
  "_timestamp": 1724923200000,
  "_hmac": "hmac_for_integrity_check"
}
```

## Миграция данных

Код автоматически поддерживает чтение старых файлов в формате v2.0 и преобразует их в новый формат при первом сохранении.

## Безопасность

- Каждое значение шифруется индивидуально с собственным IV
- HMAC защищает от модификации данных
- Временные метки предотвращают replay-атаки
- Контрольные суммы обеспечивают целостность данных
