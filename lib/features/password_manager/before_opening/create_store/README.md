# Создание хранилища - многошаговая форма

## Обзор

Модуль создания хранилища теперь реализован в виде многошаговой формы для улучшения UX и структурирования процесса создания базы данных.

## Структура

```
create_store/
├── create_store.dart              # Основной экран с навигацией по шагам
├── create_store_control.dart      # Контроллер состояния (Riverpod Notifier)
├── README.md                       # Данная документация
└── widgets/
    ├── step_1_basic_info.dart     # Шаг 1: Основная информация
    ├── step_2_security.dart       # Шаг 2: Настройка безопасности
    ├── step_3_storage_path.dart   # Шаг 3: Выбор пути хранения
    └── step_4_confirmation.dart   # Шаг 4: Подтверждение и создание
```

## Шаги создания хранилища

### Шаг 1: Основная информация
**Файл**: `step_1_basic_info.dart`

Пользователь вводит:
- **Название хранилища** (обязательно, 3-50 символов)
- **Описание** (необязательно, до 200 символов)

**Валидация**:
- Название не пустое
- Название содержит только допустимые символы (буквы, цифры, пробелы, `-`, `_`)
- Описание не превышает лимит

### Шаг 2: Настройка безопасности
**Файл**: `step_2_security.dart`

Пользователь настраивает:
- **Мастер-пароль** (обязательно)
- **Подтверждение пароля** (должно совпадать)
- **Автоматический вход** (опция сохранения пароля с предупреждением)

**Валидация**:
- Пароль не пустой
- Пароли совпадают

**Безопасность**:
- Явное предупреждение о рисках при включении автоматического входа
- Визуальное выделение опасной настройки (красный цвет)

### Шаг 3: Выбор пути хранения
**Файл**: `step_3_storage_path.dart`

Пользователь выбирает:
- **Предустановленный путь** (по умолчанию в `Documents/Hoplixi/storages`)
- **Пользовательский путь** (с возможностью выбора через диалог)

**Особенности**:
- Автоматическое создание директорий
- Визуализация итогового пути
- Возможность изменить путь в любой момент

### Шаг 4: Подтверждение
**Файл**: `step_4_confirmation.dart`

Отображает сводку всех введенных данных:
- Название и описание
- Статус автоматического входа (с предупреждением если включен)
- Итоговый путь к файлу
- Информационное сообщение о возможностях после создания

**Действие**: Кнопка "Создать хранилище" запускает процесс создания БД.

## Контроллер состояния

### CreateStoreFormState

```dart
class CreateStoreFormState {
  final String storeName;
  final String storeDescription;
  final String masterPassword;
  final String confirmPassword;
  final bool isDefaultPath;
  final String customPath;
  final String finalPath;
  final bool saveMasterPassword;
  final bool isLoading;
  final String? errorMessage;
  final Map<String, String?> fieldErrors;
  final int currentStep; // 0-3
}
```

### Методы навигации

- `nextStep()` - переход к следующему шагу (с валидацией)
- `previousStep()` - возврат к предыдущему шагу
- `goToStep(int step)` - переход к конкретному шагу
- `isCurrentStepValid()` - проверка валидности текущего шага

### Валидация шагов

Каждый шаг имеет свою логику валидации в методе `_canProceedToNextStep()`:

- **Шаг 0**: название не пустое и нет ошибок
- **Шаг 1**: пароли заполнены, совпадают и нет ошибок
- **Шаг 2**: путь не пустой
- **Шаг 3**: все данные валидны (`isValid` getter)

## UI/UX особенности

### Индикатор прогресса

- Визуальная шкала прогресса с 4 шагами
- Интерактивные элементы (можно вернуться к пройденным шагам)
- Визуальные состояния: завершен (галочка), активный, будущий

### Навигация

- **Кнопка "Назад"**: возврат к предыдущему шагу (скрыта на первом шаге)
- **Кнопка "Далее"**: переход к следующему шагу (активна только при валидном шаге)
- **Кнопка "Создать хранилище"**: на последнем шаге запускает создание БД

### Адаптивность

Все шаги адаптированы под разные размеры экрана с использованием:
- `SingleChildScrollView` для прокрутки длинного контента
- Адекватные отступы и spacing
- Responsive кнопки и элементы управления

## Поток данных

```
UI (шаги) 
  ↓
createStoreControllerProvider (Notifier)
  ↓
CreateStoreFormState (state management)
  ↓
Service (при создании)
  ↓
DAO → Drift → SQLCipher
```

## Обработка ошибок

- Валидационные ошибки отображаются под полями ввода
- Общие ошибки показываются через `ToastHelper.error()`
- При успешном создании - переход на dashboard с уведомлением

## Очистка данных

### Автоматическая очистка:
- При успешном создании хранилища
- При выходе с экрана (back button)
- При системной навигации назад

### Методы:
- `clearAllData()` - полная очистка состояния
- `clearSensitiveData()` - очистка только паролей
- `clearError()` - очистка сообщения об ошибке

## Безопасность

- Пароли никогда не логируются
- Явные предупреждения о рисках автоматического входа
- Очистка контроллеров при dispose
- Безопасное хранение через SecureStorage (если включен автовход)

## Использование

```dart
// Навигация на экран создания
context.go(AppRoutes.createStore);

// Доступ к контроллеру
final controller = ref.read(createStoreControllerProvider.notifier);

// Проверка состояния
final formState = ref.watch(createStoreControllerProvider);
final isReady = ref.watch(createStoreReadyProvider);
```

## Расширение

Для добавления нового шага:

1. Создать виджет в `widgets/step_N_xxx.dart`
2. Добавить логику валидации в `_canProceedToNextStep()`
3. Добавить case в `_buildStepContent()`
4. Добавить название в `_stepTitles`
5. Обновить условие `isLastStep` (увеличить число шагов)

## Зависимости

- `flutter_riverpod` - state management
- `go_router` - навигация
- `file_picker` - выбор пути (шаг 3)
- `path_provider` - получение системных путей
- Кастомные UI компоненты из `lib/features/global/widgets/`
