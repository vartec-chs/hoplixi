# Диагностика проблемы установки WebRTC соединений

## Проблема
Устройства находят друг друга через mDNS, но WebRTC соединения не устанавливаются - происходит таймаут через 15 секунд.

## Добавленное логирование

Теперь в логах будет отображаться подробная информация:

### 1. В connectToDevice():
- "=== НАЧАЛО УСТАНОВКИ СОЕДИНЕНИЯ ==="
- Целевое устройство ID и его данные (name, IP, port)
- Создание WebRTC соединения и его ID
- Настройка подписки на состояния соединения
- Создание WebRTC offer
- Отправка offer через сигналинг с результатом

### 2. В _handleWebRTCOffer():
- "=== ОБРАБОТКА ВХОДЯЩЕГО WEBRTC OFFER ==="
- От какого устройства получен offer
- Принятие входящего соединения 
- Установка remote description (offer)
- Создание WebRTC answer
- Отправка answer обратно с результатом

### 3. В _handleWebRTCAnswer():
- "=== ОБРАБОТКА ВХОДЯЩЕГО WEBRTC ANSWER ==="
- Поиск соединения для answer (в провайдере и WebRTC сервисе)
- Установка remote description (answer)

## Точки диагностики

Теперь можно определить, на каком этапе происходит сбой:

### Сценарий 1: Offer не отправляется
Если в логах нет "Результат отправки offer: true" - проблема в SignalingService или сетевом соединении.

### Сценарий 2: Offer отправляется, но не получается
Если есть "Результат отправки offer: true", но нет "=== ОБРАБОТКА ВХОДЯЩЕГО WEBRTC OFFER ===" - проблема в HTTP запросе между устройствами.

### Сценарий 3: Offer обрабатывается, но answer не отправляется
Если есть обработка offer, но нет "Результат отправки answer: true" - проблема в создании answer или его отправке.

### Сценарий 4: Answer не получается
Если answer отправлен, но нет "=== ОБРАБОТКА ВХОДЯЩЕГО WEBRTC ANSWER ===" - проблема в получении answer.

### Сценарий 5: WebRTC соединение не устанавливается
Если весь сигналинг работает, но нет "WebRTC соединение установлено успешно" - проблема в WebRTC PeerConnection или DataChannel.

## Следующие шаги диагностики

1. **Запустить приложение на двух устройствах**
2. **Попытаться отправить сообщение**
3. **Проанализировать логи** на обоих устройствах
4. **Определить на каком этапе происходит сбой**
5. **Исправить конкретную проблему**

## Возможные проблемы и решения

### 1. Сигналинг не работает между устройствами
- Проверить firewall
- Проверить что устройства в одной сети
- Проверить HTTP клиент timeout (10 секунд)

### 2. WebRTC PeerConnection не создается
- Проверить ICE servers конфигурацию
- Проверить что WebRTCService правильно создает PeerConnection

### 3. DataChannel не открывается
- Проверить настройки DataChannel
- Проверить обработчики событий DataChannel

### 4. Stream subscription не получает события
- Проверить что WebRTCService правильно отправляет события в connectionStates stream
- Проверить что события не фильтруются where() условием

Дата: 26 сентября 2025 г.